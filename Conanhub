local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

local Window = Rayfield:CreateWindow({
	Name = "Conan Hub",
	LoadingTitle = "Conan Hub",
	LoadingSubtitle = "by Tung",
	ConfigurationSaving = {
		Enabled = true,
		FolderName = "ConanHubConfig",
		FileName = "FlyToggle"
	},
	KeySystem = false
})

local FlyScript
local FlyTab = Window:CreateTab("Fly", 4483362458)

FlyTab:CreateToggle({
	Name = "Toggle Fly",
	CurrentValue = false,
	Flag = "FlyToggle",
	Callback = function(Value)
		if Value then
			FlyScript = Instance.new("LocalScript")
			FlyScript.Name = "ConanFlyScript"
			FlyScript.Source = game:HttpGet("https://raw.githubusercontent.com/XNEOFF/FlyGuiV3/main/FlyGuiV3.txt")
			FlyScript.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")
			Rayfield:Notify({
				Title = "Fly Enabled",
				Content = "Đã bật Fly GUI",
				Duration = 3,
			})
		else
			local gui = game.Players.LocalPlayer:FindFirstChild("PlayerGui")
			if gui and gui:FindFirstChild("ConanFlyScript") then
				gui:FindFirstChild("ConanFlyScript"):Destroy()
			end
			Rayfield:Notify({
				Title = "Fly Disabled",
				Content = "Đã tắt Fly GUI",
				Duration = 3,
			})
		end
	end,
})

local MainTab = Window:CreateTab("Main", 4483362458)

-- ESP Toggle
local ESPEnabled = false
local ESPObjects = {}

local function createESP(player)
	if player.Character and player.Character:FindFirstChild("Head") then
		local Billboard = Instance.new("BillboardGui")
		Billboard.Name = "ConanESP"
		Billboard.Adornee = player.Character.Head
		Billboard.Size = UDim2.new(0, 100, 0, 20)
		Billboard.StudsOffset = Vector3.new(0, 2, 0)
		Billboard.AlwaysOnTop = true

		local Label = Instance.new("TextLabel")
		Label.Size = UDim2.new(1, 0, 1, 0)
		Label.Text = player.Name
		Label.TextColor3 = Color3.fromRGB(255, 0, 0)
		Label.TextScaled = true
		Label.BackgroundTransparency = 1
		Label.Parent = Billboard

		Billboard.Parent = player.Character
		table.insert(ESPObjects, Billboard)
	end
end

local function toggleESP(enable)
	ESPEnabled = enable
	if enable then
		for _, p in pairs(game.Players:GetPlayers()) do
			if p ~= game.Players.LocalPlayer then
				createESP(p)
			end
		end
		game.Players.PlayerAdded:Connect(function(p)
			p.CharacterAdded:Connect(function()
				wait(1)
				createESP(p)
			end)
		end)
	else
		for _, esp in pairs(ESPObjects) do
			if esp and esp.Parent then
				esp:Destroy()
			end
		end
		ESPObjects = {}
	end
end

MainTab:CreateToggle({
	Name = "ESP (Hiện tên người chơi)",
	CurrentValue = false,
	Flag = "ESPToggle",
	Callback = function(Value)
		toggleESP(Value)
		Rayfield:Notify({
			Title = "ESP",
			Content = Value and "Đã bật ESP" or "Đã tắt ESP",
			Duration = 2,
		})
	end,
})

-- Speed Slider
MainTab:CreateSlider({
	Name = "Speed",
	Range = {16, 100},
	Increment = 1,
	Suffix = "WalkSpeed",
	CurrentValue = 16,
	Flag = "SpeedSlider",
	Callback = function(Value)
		game.Players.LocalPlayer.Character.Humanoid.WalkSpeed = Value
	end,
})

-- ⚠️ PHẢI CHẠY SAU KHI ĐÃ LOAD RAYFIELD UI + CONAN HUB CHÍNH ⚠️

local PlayerTab = Window:CreateTab("Player TP", 4483362458) -- icon Roblox nhân vật

local tpSection = PlayerTab:CreateSection("Teleport to Player")

local playerName = ""

-- Ô nhập tên người chơi
PlayerTab:CreateInput({
    Name = "Nhập tên người chơi",
    PlaceholderText = "VD: tung",
    RemoveTextAfterFocusLost = false,
    Callback = function(Text)
        playerName = Text
    end,
})

-- Nút TP đến người chơi gần đúng tên
PlayerTab:CreateButton({
    Name = "Teleport",
    Callback = function()
        local foundPlayer = nil
        for _, plr in pairs(game.Players:GetPlayers()) do
            if plr.Name:lower():find(playerName:lower()) then
                foundPlayer = plr
                break
            end
        end

        if foundPlayer and foundPlayer.Character and foundPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local myChar = game.Players.LocalPlayer.Character
            if myChar and myChar:FindFirstChild("HumanoidRootPart") then
                myChar:MoveTo(foundPlayer.Character.HumanoidRootPart.Position + Vector3.new(0, 3, 0))
            end
        else
            Rayfield:Notify({
                Title = "Conan Hub",
                Content = "Không tìm thấy người chơi!",
                Duration = 3,
                Image = 4483362458,
            })
        end
    end,
})

local KillTab = Window:CreateTab("Player Kill", 4483362458)
KillTab:CreateSection("Auto Kill Player")

local autoKill = false
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local selectedTargets = {}
local oldCFrame

local function getAlivePlayers()
    local all = {}
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
            table.insert(all, p)
        end
    end
    return all
end

local function teleportBehind(target)
    local hrp = target.Character:FindFirstChild("HumanoidRootPart")
    local myHRP = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if hrp and myHRP then
        local backPos = hrp.CFrame * CFrame.new(0, 0, 3) -- phía sau
        myHRP.CFrame = CFrame.new(backPos.Position, hrp.Position)
    end
end

KillTab:CreateToggle({
    Name = "Auto Kill Player",
    CurrentValue = false,
    Callback = function(Value)
        autoKill = Value
        if autoKill then
            Rayfield:Notify({ Title = "Conan Hub", Content = "Auto Kill Started", Duration = 2 })
            oldCFrame = LocalPlayer.Character:FindFirstChild("HumanoidRootPart").CFrame
            selectedTargets = {}
            
            task.spawn(function()
                local available = getAlivePlayers()
                while autoKill and #selectedTargets < #available do
                    local target
                    repeat
                        local randomPlayer = available[math.random(1, #available)]
                        if not table.find(selectedTargets, randomPlayer) then
                            target = randomPlayer
                        end
                    until target or not autoKill
                    
                    if not target then break end
                    table.insert(selectedTargets, target)

                    local killTime = 10 -- giây
                    local elapsed = 0

                    while autoKill and elapsed < killTime do
                        teleportBehind(target)
                        task.wait(0.1)
                        elapsed += 0.1
                    end
                end

                -- Sau khi hết lượt
                if autoKill then
                    LocalPlayer.Character:FindFirstChild("HumanoidRootPart").CFrame = oldCFrame
                    Rayfield:Notify({ Title = "Conan Hub", Content = "Đã trở lại vị trí ban đầu", Duration = 3 })
                    autoKill = false
                end
            end)
        else
            Rayfield:Notify({ Title = "Conan Hub", Content = "Auto Kill Stopped", Duration = 2 })
        end
    end
})

local ConfigTab = Window:CreateTab("Config", 4483362458) -- icon gear
local ConfigSection = ConfigTab:CreateSection("Cài đặt cấu hình")

local ConfigName = ""
local SelectedConfig = ""
local AutoLoad = false
local ConfigsFolder = "ConanHubConfigs"

-- Tạo thư mục lưu nếu chưa có
if not isfolder(ConfigsFolder) then
    makefolder(ConfigsFolder)
end

-- Nhập tên để tạo config
ConfigTab:CreateInput({
    Name = "Tên Config",
    PlaceholderText = "Nhập tên config...",
    RemoveTextAfterFocusLost = false,
    Callback = function(Value)
        ConfigName = Value
    end,
})

-- Nút tạo config
ConfigTab:CreateButton({
    Name = "Tạo Config",
    Callback = function()
        if ConfigName ~= "" then
            local data = {
                speed = SpeedValue or 16,
                autoKill = _G.autoKill or false,
                autoESP = _G.autoESP or false
            }
            writefile(ConfigsFolder.."/"..ConfigName..".json", game:GetService("HttpService"):JSONEncode(data))
            Rayfield:Notify({Title = "Conan Hub", Content = "Đã lưu cấu hình!", Duration = 2})
        end
    end,
})

-- Dropdown chọn config đã tạo
local ConfigDropdown = ConfigTab:CreateDropdown({
    Name = "Chọn Config",
    Options = listfiles(ConfigsFolder),
    CurrentOption = "",
    Callback = function(Option)
        SelectedConfig = Option
    end,
})

-- Nút load config
ConfigTab:CreateButton({
    Name = "Load Config",
    Callback = function()
        if SelectedConfig and isfile(SelectedConfig) then
            local raw = readfile(SelectedConfig)
            local data = game:GetService("HttpService"):JSONDecode(raw)

            -- Gán lại giá trị tùy theo script chính
            SpeedValue = data.speed or 16
            _G.autoKill = data.autoKill
            _G.autoESP = data.autoESP
            Rayfield:Notify({Title = "Conan Hub", Content = "Đã tải cấu hình!", Duration = 2})
        end
    end,
})

-- Auto Load Toggle
ConfigTab:CreateToggle({
    Name = "Tự động tải Config khi vào game",
    CurrentValue = false,
    Callback = function(Value)
        AutoLoad = Value
        if Value and SelectedConfig then
            writefile("ConanHubConfigs/autoload.txt", SelectedConfig)
        elseif not Value and isfile("ConanHubConfigs/autoload.txt") then
            delfile("ConanHubConfigs/autoload.txt")
        end
    end,
})

-- Tự động load nếu có autoload
if isfile("ConanHubConfigs/autoload.txt") then
    local auto = readfile("ConanHubConfigs/autoload.txt")
    if isfile(auto) then
        local raw = readfile(auto)
        local data = game:GetService("HttpService"):JSONDecode(raw)
        SpeedValue = data.speed or 16
        _G.autoKill = data.autoKill
        _G.autoESP = data.autoESP
        Rayfield:Notify({Title = "Conan Hub", Content = "Auto Load Config thành công!", Duration = 2})
    end
end
